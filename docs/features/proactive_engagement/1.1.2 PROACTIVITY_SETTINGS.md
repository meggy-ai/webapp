# User-Configurable Proactivity Preferences

## Overview

Users can now customize how Meggy engages with them through a comprehensive settings page.

## Features Implemented

### Backend (Django)

✅ **Database Schema** - Added 6 new fields to Conversation model:

- `proactive_messages_enabled` - Master on/off switch
- `auto_adjust_proactivity` - Enable/disable automatic adjustments
- `min_proactivity_level` - Lower bound for auto-adjustment (1-10)
- `max_proactivity_level` - Upper bound for auto-adjustment (1-10)
- `quiet_hours_start` - Start time for quiet period (e.g., 22:00)
- `quiet_hours_end` - End time for quiet period (e.g., 08:00)

✅ **Smart Logic Updates**:

- `should_send_proactive_message()` now respects user preferences
- Checks if proactive messages are enabled
- Honors quiet hours (supports overnight ranges like 22:00-08:00)
- `adjust_proactivity()` respects min/max bounds set by user
- Only auto-adjusts if user has enabled it

✅ **API Endpoints**:

- `GET /api/conversations/{id}/proactivity_settings/` - Get current settings and stats
- `PATCH /api/conversations/{id}/update_proactivity_settings/` - Update preferences

### Frontend (Next.js)

✅ **Settings Page** (`/settings`):

- **Master Toggle**: Enable/disable all proactive messages
- **Proactivity Level Slider**: Set how active Meggy should be (1-10)
  - Visual feedback showing what each level means
  - Disabled when auto-adjust is on
- **Auto-Adjust Toggle**: Let Meggy learn your preferences
- **Min/Max Bounds**: Set limits for auto-adjustment
- **Quiet Hours**: Configure times when you don't want to be contacted
  - Supports time pickers for start/end
  - Works across midnight (e.g., 10 PM to 8 AM)
- **Engagement Stats**: View how you've responded to proactive messages
  - Total proactive messages sent
  - Number of responses
  - Response rate percentage

✅ **UI/UX Features**:

- Custom styled range sliders with indigo theme
- Toggle switches with smooth animations
- Real-time save feedback
- Responsive design
- Dark mode support
- Back navigation to chat

## Usage

### For Users

1. Navigate to `/settings` from the chat page
2. Configure your preferences:
   - Turn proactive messages on/off
   - Set your preferred activity level
   - Enable/disable auto-learning
   - Set quiet hours for undisturbed time
3. Click "Save Settings"
4. Meggy will respect your preferences immediately

### How It Works

**Proactivity Levels**:

- **1-3**: Passive - Meggy rarely reaches out (8+ hours)
- **4-6**: Moderate - Occasional check-ins (2-4 hours)
- **7-10**: Active - Frequent engagement (30 min - 2 hours)

**Auto-Adjustment**:

- If enabled, Meggy learns from your responses
- High response rate (>70%) → increases proactivity (up to your max)
- Low response rate (<30%) → decreases proactivity (down to your min)
- Adjusts within your configured bounds

**Quiet Hours**:

- Set times when you don't want interruptions
- Supports overnight ranges (e.g., 10 PM to 8 AM next day)
- Meggy won't send proactive messages during this period
- User-initiated chats always work

## Database Migration

Applied: `0006_conversation_auto_adjust_proactivity_and_more.py`

## API Examples

### Get Settings

```bash
GET /api/conversations/{id}/proactivity_settings/
```

Response:

```json
{
  "proactive_messages_enabled": true,
  "auto_adjust_proactivity": true,
  "proactivity_level": 5,
  "min_proactivity_level": 3,
  "max_proactivity_level": 8,
  "quiet_hours_start": "22:00:00",
  "quiet_hours_end": "08:00:00",
  "total_proactive_messages": 15,
  "proactive_responses_received": 12,
  "response_rate": 0.8
}
```

### Update Settings

```bash
PATCH /api/conversations/{id}/update_proactivity_settings/
Content-Type: application/json

{
  "proactive_messages_enabled": true,
  "auto_adjust_proactivity": false,
  "proactivity_level": 7,
  "quiet_hours_start": "23:00",
  "quiet_hours_end": "07:00"
}
```

## Next Enhancements

- [ ] Email/push notifications for proactive messages
- [ ] Weekly digest of engagement stats
- [ ] Custom proactivity schedules (weekday vs weekend)
- [ ] Location-based quiet hours
- [ ] Import/export settings
