# Proactive Engagement System

## Overview

Meggy AI is designed to be a **proactive AI companion** - she initiates conversations naturally, like a friend would check in on you, rather than waiting passively for user input.

## How It Works

### Proactivity Levels (1-10)

Each conversation has a proactivity level that determines how frequently Meggy reaches out:

- **Level 10**: Very proactive (30-minute cooldown between messages)
- **Level 5** (default): Moderate proactivity (2-hour cooldown)
- **Level 1**: Minimal proactivity (8-hour cooldown)

**Formula**: `cooldown_hours = 8 - (level - 1) * 0.75`

### Auto-Adjustment

The proactivity level automatically adjusts based on user engagement:

**Increases** (max 10) when:

- Response rate > 70% (user engages with most proactive messages)

**Decreases** (min 1) when:

- Response rate < 30% (user ignores most proactive messages)

This ensures Meggy learns your preferences and respects your boundaries.

### Conditions for Sending

Meggy sends a proactive message when ALL conditions are met:

1. âœ… Conversation is active
2. âœ… Proactivity level â‰¥ 1
3. âœ… Cooldown period has passed since last proactive message
4. âœ… User hasn't messaged in at least 30 minutes

### Message Generation

Proactive messages are contextual and personalized:

- Uses long-term user memories (preferences, goals, etc.)
- Adjusts tone based on proactivity level:
  - **High (8-10)**: Personal, engaging questions
  - **Medium (5-7)**: Friendly check-ins
  - **Low (1-4)**: Gentle, low-key greetings
- Considers time of day (morning, afternoon, evening, night)

### Example Messages

**Level 10 (High Proactivity)**:

> "Hey Sarah! I was thinking about your goal to learn guitar. How's that going? Any progress or challenges you'd like to talk about?"

**Level 5 (Medium)**:

> "Hi! Hope your day is going well! ğŸ˜Š"

**Level 2 (Low)**:

> "Hi ğŸ‘‹"

## Implementation

### Database Schema

```python
# Conversation model fields
proactivity_level = IntegerField(default=5)  # 1-10 scale
last_user_message_at = DateTimeField()
last_proactive_message_at = DateTimeField()
total_user_messages = IntegerField(default=0)
total_proactive_messages = IntegerField(default=0)
proactive_responses_received = IntegerField(default=0)
```

### API Endpoints

**GET `/api/conversations/{id}/check_proactive/`**

- Checks if proactive message should be sent
- Returns message if conditions are met

**POST `/api/conversations/{id}/send_message/`**

- Accepts `is_response_to_proactive` flag
- Records user engagement for adjustment

**POST `/api/conversations/{id}/adjust_proactivity/`**

- Manually triggers adjustment (primarily for testing)
- Returns old/new levels and engagement stats

### Frontend Polling

The frontend polls every 5 minutes:

```typescript
useEffect(() => {
  const checkProactive = async () => {
    const response = await conversationsAPI.checkProactive(conversationId);
    if (response.should_send && response.message) {
      // Display proactive message
      setMessages((prev) => [...prev, response.message]);
      setIsResponseToProactive(true);
    }
  };

  const interval = setInterval(checkProactive, 5 * 60 * 1000);
  return () => clearInterval(interval);
}, [conversationId]);
```

## Testing

### Quick Test

```bash
cd backend
python test_proactive.py
```

This will:

1. Login with test credentials
2. Check proactive message conditions
3. Send a test message
4. Verify proactivity adjustment

### Manual Testing

1. Login at http://localhost:3000
2. Send a few messages to Meggy
3. Wait 30+ minutes
4. Meggy will proactively reach out based on her proactivity level
5. Respond or ignore to test auto-adjustment

### Simulating Different Levels

To test different proactivity levels, modify via Django admin or shell:

```python
from apps.chat.models import Conversation
conv = Conversation.objects.first()
conv.proactivity_level = 10  # Very proactive
conv.save()
```

## Future Enhancements

- [ ] WebSocket support for instant proactive messages (no polling delay)
- [ ] User-configurable proactivity preferences in settings
- [ ] Time-of-day preferences (e.g., "Don't message me before 9am")
- [ ] Context-aware proactivity (check calendar, activity, etc.)
- [ ] Advanced ML-based engagement prediction
- [ ] Proactive message templates and variations

## Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     Poll every 5min      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Frontend  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚   Backend    â”‚
â”‚   (Next.js) â”‚                           â”‚   (Django)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                 â”‚
                                                 v
                                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                          â”‚  Proactive   â”‚
                                          â”‚  Message     â”‚
                                          â”‚  Generator   â”‚
                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                 â”‚
                                                 v
                                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                          â”‚  Memory      â”‚
                                          â”‚  System      â”‚
                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                 â”‚
                                                 v
                                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                          â”‚   Ollama     â”‚
                                          â”‚   (LLM)      â”‚
                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Key Files

- `backend/apps/chat/models.py` - Conversation model with proactivity tracking
- `backend/core/bruno_integration/proactive_messages.py` - Message generator
- `backend/apps/api/views.py` - Proactive API endpoints
- `frontend/app/chat/page.tsx` - Frontend polling logic
- `frontend/lib/api.ts` - API client methods

---

**Philosophy**: Meggy is designed to be a true AI companion - proactive, adaptive, and respectful of your boundaries. She learns from your behavior and adjusts her engagement to match your preferences, creating a natural, friend-like relationship.
