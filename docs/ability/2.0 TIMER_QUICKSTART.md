# Quick Start Guide - Timer Feature

## Prerequisites

- Python 3.10+ installed
- Node.js 18+ installed
- Django backend configured
- PostgreSQL or SQLite database

## Step 1: Apply Database Migration

```powershell
cd c:\src\meggy-ai\webapp\backend
python manage.py migrate chat
```

Expected output:

```
Running migrations:
  Applying chat.0007_timer... OK
```

## Step 2: Start Backend Services

### Terminal 1 - Django/Daphne Server

```powershell
cd c:\src\meggy-ai\webapp\backend
daphne -b 0.0.0.0 -p 8000 config.asgi:application
```

### Terminal 2 - Timer Monitor

```powershell
cd c:\src\meggy-ai\webapp\backend
python run_timer_monitor.py
```

You should see:

```
Timer monitoring scheduler started
Checking timers every 30 seconds...
Press Ctrl+C to stop
```

## Step 3: Start Frontend

### Terminal 3 - Next.js Dev Server

```powershell
cd c:\src\meggy-ai\webapp\frontend
npm run dev
```

## Step 4: Test the Timer Feature

1. **Open browser**: http://localhost:3000
2. **Login** with your credentials
3. **Go to chat page**: http://localhost:3000/chat
4. **Click the Clock icon** in the top-right header
5. **Click "New Timer"** button
6. **Create a test timer**:
   - Name: "Test Alert"
   - Duration: 4 minutes
7. **Watch the timer countdown**
8. **Test notifications**:
   - At 3:00 remaining: You'll hear 2 beeps (warning)
   - At 0:00: You'll hear 3 ascending beeps (completion)

## Testing Timer Operations

### Create Timer (2 minutes)

```powershell
# Get your access token first by logging in via UI
# Then test via curl or Python script:
cd backend
python test_timers.py
```

### Manual API Test

```bash
# Login
curl -X POST http://localhost:8000/api/auth/login/ \
  -H "Content-Type: application/json" \
  -d '{"email": "test@example.com", "password": "Test1234!"}'

# Create timer (save the returned ID)
curl -X POST http://localhost:8000/api/timers/ \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"name": "Quick test", "duration_seconds": 240}'

# Get active timers
curl http://localhost:8000/api/timers/active/ \
  -H "Authorization: Bearer YOUR_TOKEN"

# Pause timer
curl -X POST http://localhost:8000/api/timers/TIMER_ID/pause/ \
  -H "Authorization: Bearer YOUR_TOKEN"

# Resume timer
curl -X POST http://localhost:8000/api/timers/TIMER_ID/resume/ \
  -H "Authorization: Bearer YOUR_TOKEN"

# Cancel timer
curl -X POST http://localhost:8000/api/timers/TIMER_ID/cancel/ \
  -H "Authorization: Bearer YOUR_TOKEN"
```

## Verification Checklist

### Backend

- [ ] Migration applied successfully
- [ ] Daphne server running on port 8000
- [ ] Timer monitor running and checking every 30 seconds
- [ ] No errors in terminal logs

### Frontend

- [ ] Next.js dev server running on port 3000
- [ ] Can access chat page
- [ ] Clock icon visible in header
- [ ] Timer panel opens when clicking Clock icon

### Timer Functionality

- [ ] Can create new timer
- [ ] Timer appears in active list
- [ ] Countdown updates every second
- [ ] Color changes (green → yellow → red)
- [ ] Progress bar animates
- [ ] Can pause/resume timer
- [ ] Can cancel timer

### Notifications

- [ ] WebSocket connected (check browser console)
- [ ] 3-minute warning plays sound
- [ ] 3-minute warning shows in chat
- [ ] Completion plays different sound
- [ ] Completion shows in chat

## Troubleshooting

### "Timer monitoring scheduler" not starting

**Issue**: Python can't find manage.py  
**Solution**: Make sure you're in the `backend` directory

### No audio notifications

**Issue**: Browser blocking auto-play  
**Solution**:

1. Click anywhere in the page first
2. Check browser audio permissions
3. Unmute the browser tab

### Timer not updating

**Issue**: WebSocket not connected  
**Solution**:

1. Check browser console for WebSocket errors
2. Verify JWT token is valid
3. Restart Daphne server

### 3-minute warning not appearing

**Issue**: Timer monitor not running  
**Solution**: Make sure `run_timer_monitor.py` is running in a separate terminal

### "Cannot connect to WebSocket"

**Issue**: Daphne not running or wrong port  
**Solution**:

1. Verify Daphne is running: `netstat -an | findstr 8000`
2. Check ASGI configuration in `config/asgi.py`

## Next Steps

After verifying the timer feature works:

1. **Integrate with Chat**:
   - Add natural language parsing: "set a timer for 10 minutes"
   - Let Meggy suggest timers based on context

2. **Customize Notifications**:
   - Add user preferences for alert sounds
   - Customize warning times

3. **Add More Features**:
   - Timer templates (Pomodoro, etc.)
   - Recurring timers
   - Timer history and statistics

## Production Deployment

For production, you'll need:

1. **Use Redis for Channel Layer**:

   ```python
   CHANNEL_LAYERS = {
       'default': {
           'BACKEND': 'channels_redis.core.RedisChannelLayer',
           'CONFIG': {
               'hosts': [('localhost', 6379)],
           },
       },
   }
   ```

2. **Run Timer Monitor as Service**:
   - Linux: systemd service
   - Windows: Windows Service or Task Scheduler
   - Docker: Separate container

3. **Use Production ASGI Server**:
   - Behind nginx/Apache
   - With SSL/TLS
   - Proper worker configuration

4. **Environment Variables**:
   ```bash
   DJANGO_SETTINGS_MODULE=config.settings.production
   TIME_ZONE=America/New_York
   ```

## Support

For issues or questions:

1. Check the [Timer Feature Documentation](./TIMER_FEATURE.md)
2. Review Django logs in terminal
3. Check browser console for frontend errors
4. Verify WebSocket connection status
